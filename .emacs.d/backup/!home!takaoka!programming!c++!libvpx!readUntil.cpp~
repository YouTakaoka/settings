#include<stdlib.h>
#include<stdio.h>
#include<string.h>
#include<unistd.h>
#include<sys/types.h>
#include<sys/stat.h>
#include<fcntl.h>

int readUntil(int fd, char* buf, char str[], const int max);

int main(int argc, char* argv[]){
  int fd = open("temp", O_RDONLY);
  if(fd < 0){
    fprintf(stderr, "Failed to open file.\n");
    return 1;
  }
  
  char buf[100000];
  char END[] = "###end###";
  int len = readUntil(fd, buf, END, 100000);
  printf("%d\n", len);
  close(fd);
  return 0;
}


/**
* Read from file pointer fd into buffer buf until string str appears
* @ret length of the string (-1 if the string not found or reached to max)
*/
int readUntil(int fd, char* buf, char str[], const int max){
  int l;
  char c;
  int sl = strlen(str);
  
  for(l=0; (c = read(fd, buf, 1))>0 && l<max; l++){
    buf[l] = c;
    if(l+1 >= sl && memcmp(buf+l-sl+1, str, sl)==0){
      return l-sl+1;
    }
  }

  return -1;
}
